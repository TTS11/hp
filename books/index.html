<!DOCTYPE html>
<html>
<meta charset="UTF-8">
<title>読書検索</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/jpg" href="/ttshome/1678453241image.jpg">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap" rel="stylesheet">

<head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <style>

        body {
            font-family: "Noto Sans JP", sans-serif;
            font-optical-sizing: auto;
            font-weight: 500;
            font-style: normal;
            padding: 20px;
        }

        .book-item {
            margin-bottom: 10px;
        }

        h4 {
            text-align: center;
        }

        details {
            border: 1px solid #aaa;
            border-radius: 4px;
            padding: 0.5em 0.5em 0;
        }

        summary {
            font-weight: bold;
            margin: -0.5em -0.5em 0;
            padding: 0.5em;
        }

        details[open] {
            padding: 0.5em;
        }

        details[open] summary {
            border-bottom: 1px solid #aaa;
            margin-bottom: 0.5em;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>読書検索</h1>
        <div class="input-group mb-3">
            <input type="text" id="search-input" class="form-control" placeholder="書名orひらがなで検索">
            <div class="input-group-append">
                <button class="btn btn-outline-secondary" type="button" onclick="clearInput()">✖</button>
                <button class="btn btn-outline-secondary" type="button" onclick="searchBooks()">検索</button>
            </div>
        </div>
        <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" value="" id="sort-by-rating">
            <label class="form-check-label" for="sort-by-rating">
                評価順で並べ替え
            </label>
        </div>
        <h3>
            <div id="results-count" class="container text-center"></div>
        </h3>
        <ul id="book-list" class="list-group"></ul>
    </div>
    <br>
    <hr><br>
    <h3>
        <div id="book-count" class="container text-center"></div>
    </h3><br>
    <details>
        <summary>使い方はこちら</summary>
        <h4>2023-07-26から記録しています<br>
            数字は半角の算用数字、特殊記号も半角です<br>
            書名（ひらがなでも可）で検索してください。<br>
            評価は、僕の独断と偏見に基づいているのであまり参考にしないでください<br>
            読み方のミスなどは気付き次第修正します。<br>
            評価機能の開発が遅れたので、評価が書いていない本があります。
        </h4>
    </details><br>
    <details>
        <summary>書籍データベース更新情報</summary>
        <h4>書籍データベース更新日<br>
            2024-10-27<br>
            2024-09-21<br>
            2024-08-16<br>
            2024-02-14<br>
            2023-12-28<br>
            2023-12-16<br>
            2023-11-18<br>
            2023-10-31<br>
            2023-10-14<br>
            2023-10-01<br>
            2023-09-06<br>
            2023-08-23<br>
            2023-08-02<br>
            2023-08-01<br>
        </h4>
    </details>
    <details>
        <summary>システムアップデート情報</summary>
        <h4>
            2024-11-23<br>
            スマホで見たときのデザインを改善しました。<br>
            作者情報タグを追加しました。（順次追加予定）
            <br>2024-10-27<br>
            本のリストファイルを検索システムファイルと分割しました。
            <br>
            <br>2023-08-02<br>
            書名（漢字込み）での検索に対応しました。<br>
            検索アルゴリズムを修正・改善しました。<br>
            書名を修正しました。<br>
            検索欄から検索文字を削除するボタンを追加しました。<br><br>
            2023-08-03<br>
            子供の科学のデータベースを更新しました。<br>
            持っている東洋経済のデータベースをテストとして作成しました。<br>
            近々実装します。<br>
            評価データベースを更新しました。<br><br>
            2023-08-01<br>
            エンターキーを押しても検索ができるようにしました。<br>
            データベースを更新し、雑誌の情報も追加しました。<br>
            評価機能を追加しました。<br><br>
            2023-07-28<br>
            検索結果数と収録冊数の自動表示システムを実装しました。<br><br>
            2023-07-26<br>
            正式版公開<br><br>
            2023-07-24<br>
            ベータ版公開
        </h4>
    </details>
    <script>
        // 書籍データを保持する配列
        var books = [];
        // 書籍データを取得して books 配列に格納
        function fetchBooks() {
            return fetch('books.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok");
                    }
                    return response.json();
                })
                .then(data => {
                    books = data;
                    updateBookCount();
                })
                .catch(error => console.error("Error fetching books:", error));
        }
    function searchBooks() {
        var input = document.getElementById('search-input').value;
        var list = document.getElementById('book-list');
        var sortByRating = document.getElementById('sort-by-rating').checked;

        // 現在のリストをクリア
        while (list.firstChild) {
            list.removeChild(list.firstChild);
        }

        // 検索条件に一致する書籍をフィルタリング
        var results = books.filter(book => book.hiragana.includes(input) || book.kanji.includes(input));
        results.sort((a, b) => matchScore(b, input) - matchScore(a, input));

        var uniqueResults = [];
        var addedTitles = new Set();
        results.forEach(result => {
            if (!addedTitles.has(result.kanji)) {
                uniqueResults.push(result);
                addedTitles.add(result.kanji);
            }
        });

        if (sortByRating) {
            uniqueResults.sort((a, b) => (b.hyok || 0) - (a.hyok || 0));
        }

        var resultsCountDiv = document.getElementById('results-count');
        if (uniqueResults.length === 0) {
            var listItem = document.createElement('li');
            listItem.textContent = '検索結果はありません。';
            listItem.className = 'list-group-item';
            list.appendChild(listItem);
            resultsCountDiv.textContent = "検索結果数：0";
        } else {
            uniqueResults.forEach(result => {
                var listItem = document.createElement('li');
                listItem.className = 'list-group-item book-item';

                // タイトル
                var title = document.createElement('div');
                title.textContent = result.kanji;
                title.style.fontWeight = 'bold';

                // ひらがなタイトル
                var subtitle = document.createElement('div');
                subtitle.textContent = result.hiragana;
                subtitle.style.fontStyle = 'italic';

                // 著作者（writeタグの内容）
                var author = document.createElement('div');
                author.textContent = result.write || '著作者情報なし';
                author.style.color = 'gray';

                // リストアイテムに追加
                listItem.appendChild(title);
                listItem.appendChild(subtitle);
                listItem.appendChild(author);

                // 評価があれば右上に表示
                if (result.hyok) {
                    var rating = document.createElement('span');
                    rating.textContent = '評価：' + result.hyok + '/5';
                    rating.style.float = 'right';
                    listItem.appendChild(rating);
                }

                list.appendChild(listItem);
            });
            resultsCountDiv.textContent = "検索結果数：" + uniqueResults.length;
        }
    }


        // 本の総数を表示
        function updateBookCount() {
            var bookCountDiv = document.getElementById('book-count');
            bookCountDiv.textContent = "収録冊数： " + books.length + " 冊";
        }

        // 書籍データをページロード時に取得
        window.onload = function () {
            fetchBooks();
        };

        // Enterキーで検索実行
        document.getElementById('search-input').addEventListener('keydown', function (e) {
            if (e.keyCode === 13) {
                searchBooks();
            }
        });

        // 並べ替え変更時に検索実行
        document.getElementById('sort-by-rating').addEventListener('change', function () {
            searchBooks();
        });

        // 入力フィールドをクリア
        function clearInput() {
            var input = document.getElementById('search-input');
            input.value = '';
        }

        // 一致度を計算
        function matchScore(book, input) {
            var matchIndexHiragana = book.hiragana.indexOf(input);
            var matchIndexKanji = book.kanji.indexOf(input);
            if (matchIndexHiragana !== -1) {
                return (input.length / book.hiragana.length) + 1;
            } else if (matchIndexKanji !== -1) {
                return input.length / book.kanji.length;
            }
            return 0;
        }
    </script>
</body>

</html>
